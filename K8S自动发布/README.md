# 环境
使用python2.7 即linux自带python版本

需要更改对应k8s部署文件的yaml路径(固定下来，一劳永逸)及新版本镜像号(每次都需要改)

# 命令
例如：

python k8s-deploy.py   nginx  mysql 

就会先更新nginx、再更新mysql

如果ngixn更新失败，则不更新mysql

# 自动发布
由于本人python不是特别精通(自学一段时间就开始用了，没有啥高大上的算法逻辑等等，写的也不是特别规范，希望看到的多些指点，少些嘲笑)

主要就是4个函数

- def pods_upgrade_success(project)  
查看容器是否滚动更新成功，已镜像号唯一来判断

比如当前镜像版本为1.0 滚动更新的版本为1.1

那么在k8s更新容器的时候就会存在多个镜像号，将镜像号的值添加到列表里，然后set()去重,如果只有一个镜像号说明滚动更新成功

为了方便观察引用了Counter() 一个计数器工具提供快速和方便的计数，你就可以轻松的看到打印出来的镜像号的个数了

比如4个容器都是1.0 你要更新到1.1

那么打印出来的效果就是

```
{'1.0':4,'1.1':1}
{'1.0':3,'1.1':2}
------逐渐到
{'1.1':4,'1.0':1}
{'1.1':4}
```

一般来说只要镜像号能增长，那就说明新代码能跑起来了

当然，这个函数可以后期继续改进，比如一段时间如果新镜像号的容器数量不上升则直接打印预警信息等等

- def pods_health(time_process,id) 

查看滚动更新完成时间内日志是否含报错或启动成功等关键字，(和开发人员沟通的效果就是只要jvm running了就行了，其他的报错属于业务上面报错，不在和运维有关，嘻嘻)

每个人的标准不一样，可以酌情修改

检查正常返回yes

- def deploy(project)

计算 开始调用主函数到此函数的触发 的累计时间，拿到现有的容器id，循环执行pods_health(time_process,id) 

查看每个容器是否都出现关键字(判断成功与否的标准)，通过pods_health返回值做判断

日志分析正常返回1

- def upgrade(project)

执行kubectl apply命令  需要更改yaml文件地址

- if __name__ == "__main__"
     循环调用以下函数并将成功的个数计数
  ```
     upgrade(project)  
     if deploy(i)==1:
        print "稍等片刻，休息一下" 
        time.sleep(5) 
        succ.append(i)
     else:
        print ("%s项目发布失败，终止整个发布"%(i))
        break
  ```
     判断成功的计数量是否等于输入时的项目的个数，等于则说明每个项目都依次发布完成
     
# 总结
逻辑还是较为简单的

- 执行更新命令

- 检查是否更新成功(日志关键字摘取分析)

- 返回结果通过后继续更新

- 统计整个发布数量

# 改进
由于微服务关系比较紧凑，一个应用服务的更新容易被调用方所依赖，则如果此项目发布失败不停止，发布后面的项目会出现链式雪崩反应。

- 回退

当然这个脚本没有写回退的功能是因为生产环境出问题，一般得开发人员先定位报错，然后分析，再投产。目前每次出问题都得让开发人员过来看报错。

定位报错这点我想了一下方法，可以直接将更新时间内所有容器的日志都拉取出来给开发人员看，然后先让项目回退

- 修改镜像号

目前更改镜像号需要人工去配置文件更改，由于生产环境和线下分离，只能通过线下去传送镜像到生产环境，无法做到在推送镜像的那一步就加入这个脚本，不知道有啥办法


- 告警

后期做到更自动化地程度，如果发布失败就发邮件告警，不需要人工去看日志是否更新成功等等

如果有什么建议希望可以留言~~~